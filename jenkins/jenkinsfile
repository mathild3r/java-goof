properties([pipelineTriggers([githubPush()])])

pipeline {
    agent any

    tools {
        maven 'maven' 
        nodejs 'npm'
        snyk 'snyk'
    }

    environment {
        SNYK_TOKEN = credentials('snyk-api-token')
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')
        GIT_REPO_NAME = 'java_goof'
        OWNER_NAME = 'mathild3r'
    }

    stages {
        stage('Initialize & Cleanup Workspace') {
                  steps {
                    echo 'Initialize & Cleanup Workspace'
                    sh 'ls -la'
                    sh 'rm -rf *'
                    sh 'rm -rf .git'
                    sh 'rm -rf .gitignore'
                    sh 'ls -la'
                  }
              }

        stage('Git Clone') {
            steps {
                git url: 'https://github.com/mathild3r/java-goof.git'
                sh 'ls -la'
            }
        }
        
        stage('installations') {
            steps {
                sh 'npm i -g snyk-prevent-gh-commit-status'
                sh 'npm install -g snyk'
            }
        }
        
        stage('Snyk Test using Snyk CLI') {
            steps {
                echo 'Running Snyk test'
                sh 'snyk test --all-projects --json-file-output=snykTestResults.json || true'
                sh 'echo $GIT_URL'
                sh 'echo $GIT_COMMIT'
                sh 'echo $JOB_URL'
                sh 'echo $GITHUB_PR_NUMBER'
                sh 'echo GITHUB_PR_SOURCE_REPO_OWNER'
                sh 'echo hope this is the last one'
                sh 'npx snyk-prevent-gh-commit-status ./snykTestResults.json $GITHUB_TOKEN $OWNER_NAME $GIT_REPO_NAME $GIT_COMMIT $CHANGE_ID'
            }
        }
    }
}
