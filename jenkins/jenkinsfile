properties([pipelineTriggers([githubPush()])])

pipeline {
    agent any

    tools {
        maven 'maven' 
        nodejs 'npm'
        snyk 'snyk'
    }

    environment {
        SNYK_TOKEN = credentials('snyk-api-token')
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')
    }

    stages {

      stage('Initialize & Cleanup Workspace') {
                  steps {
                    echo 'Initialize & Cleanup Workspace'
                    sh 'ls -la'
                    sh 'rm -rf *'
                    sh 'rm -rf .git'
                    sh 'rm -rf .gitignore'
                    sh 'ls -la'
                  }
              }

        stage('Git Clone') {
            steps {
                git url: 'https://github.com/mathild3r/java-goof.git'
                sh 'ls -la'
            }
        }
        
        stage('installations') {
            steps {
                sh 'npm i -g snyk-prevent-gh-commit-status'
                sh 'npm install -g snyk'
            }
        }
        
        stage('Snyk Test using Snyk CLI') {
            steps {
                echo 'Running Snyk test'
                sh 'snyk test --all-projects --json-file-output=snykTestResults.json || true'
                sh 'echo $GITHUB_TOKEN'
                sh 'echo $env.JOB_NAME'
                sh 'echo $env.GIT_REPO_NAME'
                sh 'echo $env.GIT_COMMIT'
                sh 'echo $env.CHANGE_ID'
                sh 'echo $env.JOB_URL'
                sh 'npx snyk-prevent-gh-commit-status ./snykTestResults.json $GITHUB_TOKEN $JOB_NAME $GIT_REPO_NAME $GIT_COMMIT $CHANGE_ID $JOB_URL'
            }
        }
    }
}